(this["webpackJsonpappointments-sample-ui"]=this["webpackJsonpappointments-sample-ui"]||[]).push([[0],{82:function(t,e,n){},91:function(t,e,n){"use strict";n.r(e);var a=n(0),i=n.n(a),o=n(12),s=n.n(o),r=(n(82),n(17)),c=n(18),l=n(47),y=n(46),u=n(6),h=n(66),d=n(117),f=n(120),g=n(128),v=n(121),S=n(122),m=n(92),p=n(123),E=n(125),b=n(127),C=n(124),j=n(67),O=n(16),I=n(49),k=function(){function t(){Object(r.a)(this,t),this.entityName="",this.entityKey="",this.version=0,this.stateDiff=[],this.isEntityDestructed=!1}return Object(c.a)(t,null,[{key:"GetEntityId",value:function(e){return t.FormatEntityId(e.entityName,e.entityKey)}},{key:"FormatEntityId",value:function(t,e){return"@".concat(t,"@").concat(e)}}]),t}(),w=function(){function t(){Object(r.a)(this,t),this.version=0,this.state={}}return Object(c.a)(t,null,[{key:"GetEntityNameAndKey",value:function(t){var e=/@([^@]+)@(.+)/.exec(t);return{entityNameLowerCase:e?e[1]:"",entityKey:e?e[2]:""}}}]),t}(),N=n(50),R=n(24),K="/a/p/i",A=function(t){Object(l.a)(n,t);var e=Object(y.a)(n);function n(t){var a;return Object(r.a)(this,n),(a=e.call(this,O.d.instance))._configFabric=t,a}return Object(c.a)(n,[{key:"send",value:function(t){var e=this;if(t.url.includes(K)){var a=this._configFabric();if(a.accessTokenFactory)return a.accessTokenFactory().then((function(a){return t.headers={},t.headers.Authorization="Bearer "+a,Object(N.a)(Object(R.a)(n.prototype),"send",e).call(e,t)}));if(a.fakeUserNamePromise)return a.fakeUserNamePromise.then((function(a){return a&&(t.headers={},t.headers["x-ms-client-principal-name"]=a),Object(N.a)(Object(R.a)(n.prototype),"send",e).call(e,t)}))}return Object(N.a)(Object(R.a)(n.prototype),"send",this).call(this,t)}}]),n}(O.a),x=function(){function t(e){Object(r.a)(this,t),this._maxKnownEntityIdsToPersist=e,this.States={},this.LocalStorageKnownIdsKey="DurableEntitySetKnownEntityIds"}return Object(c.a)(t,[{key:"getState",value:function(t){return this.States[t]}},{key:"getStatesCopy",value:function(){return Object.assign({},this.States)}},{key:"addOrUpdateState",value:function(t,e){if(this.States[t]=e,localStorage){var n=Object.keys(this.States).slice(0,this._maxKnownEntityIdsToPersist());localStorage.setItem(this.LocalStorageKnownIdsKey,JSON.stringify(n))}}},{key:"removeState",value:function(t){if(delete this.States[t],localStorage){var e=Object.keys(this.States).slice(0,this._maxKnownEntityIdsToPersist());localStorage.setItem(this.LocalStorageKnownIdsKey,JSON.stringify(e))}}},{key:"getStoredEntityIds",value:function(t){if(!localStorage)return[];var e=localStorage.getItem(this.LocalStorageKnownIdsKey);return e?JSON.parse(e).filter((function(e){return w.GetEntityNameAndKey(e).entityNameLowerCase===t})):[]}},{key:"removeStoredEntityIds",value:function(t){localStorage&&localStorage.removeItem(this.LocalStorageKnownIdsKey)}}]),t}(),L=function(){function t(e){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];Object(r.a)(this,t),this.items=[],this._entityNameLowerCase=void 0,this._entityNameLowerCase=e.toLowerCase(),Object(u.m)(this,{items:u.n}),n&&this.attachAllEntities()}return Object(c.a)(t,[{key:"attachAllEntities",value:function(){var e=this;return t.initSignalR(),t.EntitySets[this._entityNameLowerCase]=this.items,t.fetchAndApplyKnownEntityStates(this._entityNameLowerCase).then((function(){return t.fetchAndApplyAllEntityStates(e._entityNameLowerCase)}))}},{key:"attachEntity",value:function(e){var n=k.FormatEntityId(this._entityNameLowerCase,e);t.EntityStates.getState(n)||(t.EntitySets[n]=this.items,t.attachEntity(this._entityNameLowerCase,e,void 0))}},{key:"createEntity",value:function(e){t.createEntity(this._entityNameLowerCase,e,void 0)}},{key:"signalEntity",value:function(e,n,a){return t.signalEntity(this._entityNameLowerCase,e,n,a)}},{key:"callEntity",value:function(e,n,a){return t.callEntity(this._entityNameLowerCase,e,n,a)}},{key:"updateEntityMetadata",value:function(e,n){return t.updateEntityMetadata(this._entityNameLowerCase,e,n)}}],[{key:"attachEntity",value:function(e,n,a){t.initSignalR();var i=e.toLowerCase(),o=this.EntityStates.getState(k.FormatEntityId(i,n));return o?o.state:(a&&Object(u.l)(a),this.fetchAndApplyEntityState(i,n,0,0,a),a)}},{key:"createEntity",value:function(t,e,n){return this.updateEntityMetadata(t,e,{}),this.attachEntity(t,e,n)}},{key:"signalEntity",value:function(t,e,n,a){var i=t.toLowerCase(),o="".concat(K,"/entities/").concat(encodeURI(i),"/").concat(encodeURI(e),"/").concat(encodeURI(n));return this.HttpClient.post(o,{content:JSON.stringify(a)}).then()}},{key:"callEntity",value:function(t,e,n,a){var i=this,o=t.toLowerCase(),s="".concat(K,"/entities/").concat(encodeURI(o),"/").concat(encodeURI(e),"/").concat(encodeURI(n));return new Promise((function(t,e){i.HttpClient.post(s,{content:JSON.stringify(a)}).then((function(n){var a=JSON.parse(n.content).correlationId;i.SignalResultPromises[a]={resolve:t,reject:e}}),e)}))}},{key:"updateEntityMetadata",value:function(t,e,n){return this.signalEntity(t,e,"$update-entity-internal-metadata",n)}},{key:"setup",value:function(t){this.Config=t,this.Config.logger||(this.Config.logger=O.d.instance)}},{key:"entityAdded",value:function(t,e,n){var a=k.FormatEntityId(t,e),i=this.EntitySets[a];i?delete this.EntitySets[a]:i=this.EntitySets[t],i&&(n.entityKey=e,i.push(n))}},{key:"entityDeleted",value:function(t,e){var n=this.EntitySets[t];if(n)for(var a=0;a<n.length;a++)if(n[a].entityKey===e){n.splice(a,1);break}}},{key:"fetchAndApplyEntityState",value:function(t,e,n,a){var i=this,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s="".concat(K,"/entities/").concat(encodeURI(t),"/").concat(encodeURI(e));this.HttpClient.get(s).then((function(a){var s=JSON.parse(a.content),r=k.FormatEntityId(t,e);if(n&&s.version<n)throw new Error("Expected ".concat(r," of version ").concat(n,", but got version ").concat(s.version));o?i.applyStateChangesFrom(o,s.state):(o=s.state,Object(u.l)(o)),i.EntityStates.getState(r)||i.entityAdded(t,e,o),i.EntityStates.addOrUpdateState(r,{state:o,version:s.version})})).catch((function(s){a<i.MaxRetryCount?(a++,setTimeout((function(){i.fetchAndApplyEntityState(t,e,n,a,o)}),a*i.RetryBaseIntervalMs)):i.Config.logger.log(O.c.Error,"DurableEntitySet: failed to fetch entity state: ".concat(s))}))}},{key:"fetchAndApplyAllEntityStates",value:function(t){var e=this,n=this.EntityStates.getStatesCopy(),a="".concat(K,"/entities/").concat(encodeURI(t));return this.HttpClient.get(a).then((function(a){var i,o=Object(j.a)(JSON.parse(a.content));try{for(o.s();!(i=o.n()).done;){var s=i.value,r=s.entityKey,c=k.FormatEntityId(t,r),l=s,y=n[c];delete n[c],y?y.version<l.version?(e.Config.logger.log(O.c.Information,"DurableEntitySet: ".concat(c,", local version ").concat(y.version,", remote version ").concat(l.version,". State was updated.")),e.applyStateChangesFrom(y.state,l.state),y.version=l.version):e.Config.logger.log(O.c.Information,"DurableEntitySet: ".concat(c," is already known and is up to date. Skipping.")):(Object(u.l)(l.state),e.EntityStates.addOrUpdateState(c,l),e.entityAdded(t,r,l.state))}}catch(f){o.e(f)}finally{o.f()}for(var h in n){e.EntityStates.removeState(h);var d=w.GetEntityNameAndKey(h);e.entityDeleted(d.entityNameLowerCase,d.entityKey)}})).catch((function(t){e.Config.logger.log(O.c.Error,"DurableEntitySet: failed to fetch entity states: ".concat(t))}))}},{key:"fetchAndApplyKnownEntityStates",value:function(t){var e=this,n=this.EntityStates.getStoredEntityIds(t),a=this.EntityStates.getStatesCopy(),i="".concat(K,"/entities");return this.HttpClient.post(i,{content:JSON.stringify(n)}).then((function(t){for(var i=JSON.parse(t.content),o=0;o<n.length;o++){var s=n[o],r=w.GetEntityNameAndKey(s),c=i[o],l=a[s];l?l.version<c.version?(e.Config.logger.log(O.c.Information,"DurableEntitySet: ".concat(s,", local version ").concat(l.version,", remote version ").concat(c.version,". State was updated.")),e.applyStateChangesFrom(l.state,c.state),l.version=c.version):e.Config.logger.log(O.c.Information,"DurableEntitySet: ".concat(s," is already known and is up to date. Skipping.")):(Object(u.l)(c.state),e.EntityStates.addOrUpdateState(s,c),e.entityAdded(r.entityNameLowerCase,r.entityKey,c.state))}})).catch((function(n){e.Config.logger.log(O.c.Warning,"DurableEntitySet: failed to fetch known entity states: ".concat(n)),e.EntityStates.removeStoredEntityIds(t)}))}},{key:"entityStateChangedMessageHandler",value:function(t){var e=this,n=k.GetEntityId(t);this.Config.logger.log(O.c.Trace,"DurableEntitySet: ".concat(n," changed to version ").concat(t.version));var a=this.EntityStates.getState(n);if(t.isEntityDestructed)this.EntityStates.removeState(n),this.entityDeleted(t.entityName,t.entityKey);else if(a){var i=a.version+1;t.version>i?this.fetchAndApplyEntityState(t.entityName,t.entityKey,t.version,0,a.state):t.version===i&&(I.applyPatch(a.state,t.stateDiff),a.version=t.version)}else(this.EntitySets[n]||this.EntitySets[t.entityName])&&setTimeout((function(){return e.fetchAndApplyEntityState(t.entityName,t.entityKey,t.version,0)}),this.RetryBaseIntervalMs)}},{key:"entitySignalResponseHandler",value:function(t){var e=this.SignalResultPromises[t.correlationId];e&&(t.errorMessage?e.reject(new Error(t.errorMessage)):e.resolve(t.result),delete this.SignalResultPromises[t.correlationId])}},{key:"initSignalR",value:function(){var t=this;this.SignalRConn||(this.SignalRConn=(new O.b).withUrl("".concat(K),{httpClient:this.HttpClient,logger:this.Config.logger}).build(),this.SignalRConn.on("entity-state-changed",(function(e){return t.entityStateChangedMessageHandler(e)})),this.SignalRConn.on("entity-signal-response",(function(e){return t.entitySignalResponseHandler(e)})),this.SignalRConn.onclose((function(){return t.reconnectToSignalR()})),this.SignalRConn.start().then((function(){t.Config.logger.log(O.c.Information,"DurableEntitySet: successfully connected to SignalR")}),(function(e){t.Config.logger.log(O.c.Error,"DurableEntitySet: failed to connect to SignalR: ".concat(e))})))}},{key:"reconnectToSignalR",value:function(){var t=this;this.Config.logger.log(O.c.Information,"DurableEntitySet: reconnecting to SignalR..."),this.SignalRConn.start().then((function(){t.Config.logger.log(O.c.Information,"DurableEntitySet: reconnected to SignalR")}),(function(){setTimeout((function(){return t.reconnectToSignalR()}),t.SignalRReconnectIntervalInMs)}))}},{key:"applyStateChangesFrom",value:function(t,e){e.entityKey=t.entityKey;var n=I.createPatch(t,e);I.applyPatch(t,n)}}]),t}();L.Config={logger:O.d.instance},L.HttpClient=new A((function(){return L.Config})),L.EntitySets={},L.SignalResultPromises={},L.SignalRConn=void 0,L.SignalRReconnectIntervalInMs=5e3,L.MaxRetryCount=6,L.RetryBaseIntervalMs=500,L.DefaultMaxKnownEntityIdsToPersist=100,L.EntityStates=new x((function(){return void 0===L.Config.maxKnownEntityIdsToPersist?L.DefaultMaxKnownEntityIdsToPersist:L.Config.maxKnownEntityIdsToPersist}));var D;!function(t){t[t.Fever=1]="Fever",t[t.Headache=2]="Headache",t[t.Nausea=3]="Nausea",t[t.Rash=4]="Rash",t[t.Diarrhea=5]="Diarrhea"}(D||(D={}));var P=n(15);L.setup({fakeUserNamePromise:new Promise((function(t){var e="";fetch("/.auth/me").then((function(t){return t.json()})).then((function(n){if(!n||!n.length)throw new Error("EasyAuth seems to be not configured. Falling back to a fake user name");e=n[0].user_id,t(null)})).catch((function(){e=prompt("Enter your name:","Anonymous"),t(e)}))})),logger:{log:function(t,e){return console.log(e)}}});var F="HealthCheckEntity",M="my-health-check",T=Object(u.l)({msgText:"",state:L.createEntity(F,M,new function t(){Object(r.a)(this,t),this.history=[],this.symptoms=[]})}),U=Object(h.a)(function(t){Object(l.a)(n,t);var e=Object(y.a)(n);function n(){return Object(r.a)(this,n),e.apply(this,arguments)}return Object(c.a)(n,[{key:"sendMessage",value:function(){L.signalEntity(F,M,"sendHealthCheck",T.msgText)}},{key:"render",value:function(){var t=this;return Object(P.jsxs)(P.Fragment,{children:[Object(P.jsx)(d.a,{position:"static",color:"default",className:"app-bar",children:Object(P.jsxs)(f.a,{children:["Your symptoms so far:",T.state.symptoms.map((function(t){return Object(P.jsx)(g.a,{label:D[t],color:"secondary",variant:"outlined",className:"appointment-status-chip"})}))]})}),Object(P.jsx)(v.a,{children:T.state.history.map((function(t){return Object(P.jsx)(S.a,{children:Object(P.jsx)(m.a,{className:"appointment-paper",style:{marginLeft:t.isFromServer?0:20},children:Object(P.jsx)(p.a,{children:t.text})})})}))}),Object(P.jsx)(d.a,{position:"static",color:"default",className:"app-bar",children:Object(P.jsxs)(f.a,{children:[Object(P.jsx)(E.a,{fullWidth:!0,label:"Your message",InputLabelProps:{shrink:!0},variant:"outlined",size:"small",value:T.msgText,onChange:function(t){return T.msgText=t.target.value},onKeyPress:function(e){"Enter"===e.key&&(e.preventDefault(),t.sendMessage())}}),Object(P.jsx)(b.a,{width:20}),Object(P.jsx)(C.a,{variant:"contained",color:"default",size:"large",className:"new-appointment-button",onClick:function(){return t.sendMessage()},children:"Send"})]})})]})}}]),n}(i.a.Component));s.a.render(Object(P.jsx)(U,{}),document.getElementById("root"))}},[[91,1,2]]]);
//# sourceMappingURL=main.2653416e.chunk.js.map